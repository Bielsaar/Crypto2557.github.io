{% extends 'base.html' %}

{% block head %}
    {{ super() }}
    <script type="text/javascript" src="{{ url_for('static', filename='js/pets.js') }}"></script>
{% endblock %}
{% block app_content %}
    <div class="row super-row">
        <div class="col-sm-12 col-centered">
            {% for key, pet in pets.items() %}
            {% set key_id=key.replace(" ", "_") %}
                {%if (loop.index-1) % 6 == 0 %}<div class="row centered-row">{% endif %}
                    <div class="col-lg-2 col-4 border block padding-0">
                        <div class="row centered-row">
                            <div class="col-md-7">
                                <img id="{{key_id}}-image" class='unit-image zero-star' src="../static/{{pet['img']}}">
                            </div>
                            <div class="col-md-5">
                                <h3>{{ key }}</h3>
                            </div>
                        </div>
                        <div class="row centered-row">
                            <div class="col-md-7">
                                    <fieldset>
                                        <label class="image-checkbox" id="{{key_id}}-1star" data-pet="{{key_id}}">
                                            <img class="img-responsive" src="../static/img/stargrey.png"/>
                                            <input type="checkbox" value="10" data-stars="1"/>
                                        </label>
                                        <label class="image-checkbox" id="{{key_id}}-2star" data-pet="{{key_id}}">
                                            <img class="img-responsive" src="../static/img/stargrey.png"/>
                                            <input type="checkbox" value="30" data-stars="2"/>
                                        </label>
                                        <label class="image-checkbox" id="{{key_id}}-3star" data-pet="{{key_id}}">
                                            <img class="img-responsive" src="../static/img/stargrey.png"/>
                                            <input type="checkbox" value="80" data-stars="3"/>
                                        </label>
                                        <label class="image-checkbox" id="{{key_id}}-4star" data-pet="{{key_id}}">
                                            <img class="img-responsive" src="../static/img/stargrey.png"/>
                                            <input type="checkbox" value="180" data-stars="4"/>
                                        </label>
                                        <label class="image-checkbox" id="{{key_id}}-5star" data-pet="{{key_id}}">
                                            <img class="img-responsive" src="../static/img/stargrey.png"/>
                                            <input type="checkbox" value="330" data-stars="5"/>
                                        </label>
                                    </fieldset>
                            </div> 
                            <div class="col-md-5">
                                    <input id="{{key_id}}-fragments" data-pet="{{key_id}}" class="form-control pet-input" type="number" min="0" value="0"/>
                            </div>
                        </div>
                        <div class="row centered-row padding-sm">
                            <div class="col-3 col-kl">{{(ceil(pet["from"][0]/5)*2)|int}}</div>
                            <div class="col-3 col-kl">{{(ceil(pet["from"][1]/5)*2)|int}}</div>
                            {% if(pet["from"][2]) %} <div class="col-3 col-kl">{{(ceil(pet["from"][2]/5)*2)|int}}</div> {% endif %}
                            {% if(pet["from"][3]) %} <div class="col-3 col-kl">{{(ceil(pet["from"][3]/5)*2)|int}}</div> {% endif %}
                        </div>
                    </div>
                {%if (loop.index-1) % 6 == 5 %} </div>  {% endif %}
            {% endfor %}
        </div>
    </div>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script type="text/javascript">
    // IIFE - Immediately Invoked Function Expression
    (function(yourcode) {

        yourcode(window.jQuery, window.indexedDB, window, document);

    }(function($, indexedDB, window, document) {

        $(function() {
            $(".pet-input").each(function(){
                on_pet_input_change($(this));
            });
            $(".pet-input").bind('keyup mouseup', function () {
                var request = idb.open('endless-farming-db');
                request.then(function(db){
                    var tx = db.transaction('pets', 'readwrite');
                    var store = tx.objectStore('pets');
                    var item = {
                        name: $(this).data("pet"),
                        fragments: parseInt($(this).val())
                    };
                    var putRequest = store.put(item);
                    return tx.complete;
                }.bind(this)).then(function() {
                    val = idb.open('endless-farming-db').then(function(db){
                        var tx = db.transaction('pets', 'readwrite');
                        var store = tx.objectStore('pets');
                        return store.get($(this).data("pet"));
                    }.bind(this)).then(function(val){
                        $(this).attr("value", val["fragments"]);
                        change_stars(val);
                    });
                }.bind(this));
            });

            $(".image-checkbox").on("click", function (e) {
                var $checkbox = $(this).find('input[type="checkbox"]');
                var $input = $("#"+$(this).data("pet")+"-fragments");
                $input.val($checkbox.attr("value"));
                $input.keyup();
            });

            request = idb.open('endless-farming-db');
            request.then(function(db){
                var tx = db.transaction('player', 'readwrite');
                var store = tx.objectStore('player');
                var KL = store.get("KL");
                KL.then(function(val){
                    if (val !== undefined){
                        $(".col-kl").each(function(){
                            var $col = $(this);
                            if(val["value"]>=parseFloat($col.text())){
                                $col.css("color", "#1ca51c");
                            }
                        });
                    }
                });
            });          
        });
    }));
    </script>
{% endblock %}
