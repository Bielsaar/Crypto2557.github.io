{% extends 'base.html' %}

{% block content %}
<h1>Endless Farming</h1>
<div class="row super-row">
	<div class="col-3 col-centered padding-0">
		<div class="row centered-row">
			<div class="col-6 col-centered padding-sm">
				Knightage Level
			</div>
			<div class="col-6 col-centered padding-sm">
				 <input id="KL-number" class="form-control" type="number" min="1" value="0"/>
			</div>
		</div>
		<div class="row centered-row">
			<div class="col-6 col-centered padding-sm">
				Tickets
			</div>
			<div class="col-6 col-centered padding-sm">
				<input id="tickets-number" class="form-control" type="number" min="10" value="0"/>
			</div>			
		</div>
		<div class="row centered-row">
			<div class="col-6 col-centered padding-sm">
				Refills
			</div>
			<div class="col-6 col-centered padding-sm">
				<input id="refills-number" class="form-control" type="number" min="0" value="0" max="6"/>
			</div>			
		</div>
		<div class="row centered-row">
			<div class="col-12 col-centered padding-sm">
				<img id="gem-image" src="../static/img/gem.png">
				<label id="gem-label" for="gem-image">0</label>
			</div>
		</div>
	</div>
	<div class="col-3 col-centered padding-0">
		<table class="table table-hover" id="myTable">
			  <tbody>

			  	{% for key, pet in pet_priority.items() %}
			  		<tr id="{{key}}">
			  			<td align="center"><img id="gem-image" src="../static/{{pets[pet]['img']}}">{{pet}}</td>
			  		</tr>
			  	{% endfor %}
			  </tbody>
			</table>
	</div>
</div>
<script type="text/javascript">
(function(yourcode) {
        yourcode(window.jQuery, window.indexedDB, window, document);

    }(function($, indexedDB, window, document) {

        $(function() {
        	request = idb.open('endless-farming-db', 2);
        	request.then(function(db){
            	var tx = db.transaction('player', 'readwrite');
            	var store = tx.objectStore('player');
            	var KL = store.get("KL");
            	KL.then(function(val){
            		$("#KL-number").attr("value", val["value"]);
            	});
            	var tickets = store.get("tickets");
            	tickets.then(function(val){
            		$("#tickets-number").attr("value", val["value"]);
            	});
            	var refills = store.get("refills");
            	refills.then(function(val){
            		$("#refills-number").attr("value", val["value"]);
            		$("#gem-label").text([0, 100, 200, 400, 800, 1200, 1600][val["value"]]);
            	});
        	});
        	$("input").bind('keyup mouseup', function () {
        		$this = $(this);
        		request = idb.open('endless-farming-db', 2);
        		request.then(function(db){
            	var tx = db.transaction('player', 'readwrite');
            	var store = tx.objectStore('player');
            	var KL = store.put({name: this.attr("id").replace("-number", ""), value: this.val()});
            	}.bind($this));
        	});

        	$("#refills-number").bind('keyup mouseup', function(){
        		$this = $(this);
        		$("#gem-label").text([0, 100, 200, 400, 800, 1200, 1600][$this.val()]);
        	});
        			var fixHelperModified = function(e, tr) {
		var $originals = tr.children();
		var $helper = tr.clone();
		$helper.children().each(function(index) {
			$(this).width($originals.eq(index).width())
		});
		return $helper;
	},
		updateIndex = function(e, ui) {
			$('td.index', ui.item.parent()).each(function (i) {
				$(this).html(i + 1);
			});
		};

	$("#myTable tbody").sortable({
		helper: fixHelperModified,
		stop: updateIndex
	}).disableSelection();
	
		$("tbody").sortable({
		distance: 5,
		delay: 100,
		opacity: 0.6,
		cursor: 'move',
		update: function() {}
			});
        });

    }));
</script>
{% endblock %}