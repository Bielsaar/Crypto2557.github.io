<!DOCTYPE html>
<html>
  <head>
    <script src="/jsglue.js" type="text/javascript"></script>

    
        
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="">
        <meta name="author" content="">
    

    
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
        <link rel="stylesheet" href="/static/css/normalize.css" >
        <link rel="stylesheet" href="/static/css/ef.css" >
    

  </head>
  <body>
    
<nav class="navbar navbar-expand-lg bg-dark navbar-dark">
    <a class="navbar-brand" href="#">Endless Farming</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
                <a class="nav-link" href="/">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/pets/">Pets</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/units/">Units</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/tickets/">Tickets</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/meta_progression/">Metas</a>
            </li>
        </ul>
        <input type="file" id="dbupload" value="Import" style="display:none"/> 
        <button id="import-button" class="btn btn-dark btn-outline-light">Import</button>
        <button id="export-button" class="btn btn-dark btn-outline-light">Export</button>
                <button id="first-visit-button" data-toggle="modal" data-target="#stats-modal" data-welcome-text="Welcome to Endless Farming. If you want to use this application to its full potential please insert your knightage level, the spirit highland tickets available to you and how many times a day you buy additional tickets. You can later change it at any time by clicking the 'My Stats' button in the top right corner of the screen." style="display:none"></button>
        <button id="stats-button" class="btn btn-dark btn-outline-light" data-toggle="modal" data-target="#stats-modal" data-welcome-text="">My Stats</button>
        <div id="stats-modal" class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    	<div class="modal-content">
      		<div class="modal-header">
        		<h5 class="modal-title" id="exampleModalLongTitle">Endless Farming</h5>
        		
      			        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
      		</div>
      		<div class="modal-body">
      			<div class="row super-row justify-content-start">
      				<div id="welcome-text" class="col-12 col-centered padding-0">
      					<b></b>
      				</div>
					<div class="col-12 col-centered padding-0">
						<div class="row centered-row">
							<div class="col-3 col-centered padding-sm">
								Knightage Level
							</div>
							<div class="col-3 col-centered padding-sm">
				 				<input id="KL-number" class="form-control user-input" type="number" min="1" value="0"/>
							</div>
						</div>
						<div class="row centered-row">
							<div class="col-3 col-centered padding-sm">
								Tickets
							</div>
							<div class="col-3 col-centered padding-sm">
								<input id="tickets-number" class="form-control user-input" type="number" min="10" value="0"/>
							</div>			
						</div>
						<div class="row centered-row">
							<div class="col-3 col-centered padding-sm">
								Refills
							</div>
							<div class="col-3 col-centered padding-sm">
								<input id="refills-number" class="form-control user-input" type="number" min="0" value="0" max="6"/>
							</div>			
						</div>
						<div class="row centered-row">
							<div class="col-6 col-centered padding-sm">
								<img id="gem-image" src="../static/img/gem.png">
								<label id="gem-label" for="gem-image">0</label>
							</div>
						</div>
					</div>
				</div>
      		</div>
		</div>
	</div>
</div>
    </div> 
</nav>

    
    <div id="content" class="container">
<h1>Endless Farming</h1>
</div>


    
	
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js" integrity="sha256-T0Vest3yCU7pafRw9r+settMBX6JkKN06dqBnpQ8d30=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
   

    <script type="text/javascript" src="/static/js/lodash.min.js"></script>
    <script type="text/javascript" src="/static/js/sortable.js"></script>
    <script type="text/javascript" src="/static/js/idb.js"></script>
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <script type="text/javascript" src="/static/js/index.js"></script>
    <script type="text/javascript" src="/static/js/jquery.sortable.min.js"></script>

    <script type="text/javascript">

        String.prototype.replaceAll = function(search, replacement) {
            var target = this;
            return target.replace(new RegExp(search, 'g'), replacement);
        };
    
        function handle_nan(val){
        return (isNaN(val)) ? 0 : val;
        }

        // IIFE - Immediately Invoked Function Expression
        (function(yourcode) {

            yourcode(window.jQuery, window.indexedDB, window, document);

        }(function($, indexedDB, window, document) {

            $(function() {
                $("#import-button").click(function(){ 
                    $('#dbupload').trigger('click');
                });

                $("#dbupload").change(function(e){ 
                    var files = document.getElementById('dbupload').files;
                    var fr = new FileReader();
                    fr.onload = function(e) { 
                        var result = JSON.parse(e.target.result);                       
                        var db = new Dexie('endless-farming-db');
                        db.open().then(function(){
                            var idb_db = db.backendDB();
                            clearDatabase(idb_db, function(err) {
                                if(!err){
                                    importFromJsonString(idb_db, result, function(err) {
                                        if (!err){
                                            console.log("Imported data successfully");
                                            window.location.reload();
                                        }
                                    });
                                }
                            });
                        });
                    }
                    fr.readAsText(files.item(0));
                });

                $("#export-button").on("click", function(e){
                    var db = new Dexie('endless-farming-db');
                    db.open().then(function(){
                        var idb_db = db.backendDB();
                        exportToJsonString(idb_db, function(err, jsonString) {
                            if(err){
                                console.error(err);
                            }
                            else {
                                var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(jsonString));
                                var downloadAnchorNode = document.createElement('a');
                                downloadAnchorNode.setAttribute("href", dataStr);
                                downloadAnchorNode.setAttribute("download", "endless_farming.json");
                                document.body.appendChild(downloadAnchorNode); // required for firefox
                                downloadAnchorNode.click();
                                downloadAnchorNode.remove();
                            }
                        });
                    });                   
                });

                request = idb.open('endless-farming-db');
                request.then(function(db){
                    var tx = db.transaction('player', 'readwrite');
                    var store = tx.objectStore('player');
                    var KL = store.get("KL");
                    KL.then(function(val){
                        if (val !== undefined){
                            $("#KL-number").attr("value", val["value"]);
                        }
                    });
                    var tickets = store.get("tickets");
                    tickets.then(function(val){
                        if (val !== undefined){
                            $("#tickets-number").attr("value", val["value"]);                       
                        }
                    });
                    var refills = store.get("refills");
                    refills.then(function(val){
                        if (val !== undefined){
                            $("#refills-number").attr("value", val["value"]);
                            $("#gem-label").text([0, 100, 200, 400, 800, 1200, 1600][val["value"]]);
                        }
                    });
                });

                $(".user-input").bind('keyup mouseup', function () {
                    $this = $(this);
                    request = idb.open('endless-farming-db');
                    request.then(function(db){
                        var tx = db.transaction('player', 'readwrite');
                        var store = tx.objectStore('player');
                        var KL = store.put({name: this.attr("id").replace("-number", ""), value: this.val()});
                        if($this.attr("id") == "KL-number"){
                            updateStages(this.val());
                        }
                        calculatePetFragmentsToFarm();
                    }.bind($this));
                });

                $("#refills-number").bind('keyup mouseup', function(){
                    $this = $(this);
                    function getSum(total, num) {
                        return total + num;
                    }
                    $("#gem-label").text([0, 100, 200, 400, 800, 1200, 1600].slice(0, handle_nan(parseInt($this.val()))+1).reduce(getSum));
                });

                $('#stats-modal').on('show.bs.modal', function (event) {
                    var button = $(event.relatedTarget);
                    var text = button.data('welcome-text');
                    var modal = $(this);
                    modal.find('#welcome-text').children().first().text(text);
                });

                request = idb.open('endless-farming-db');
                request.then(function(db){
                    var tx = db.transaction('player', 'readwrite');
                    var store = tx.objectStore('player');
                    var KL = store.get("KL");
                    KL.then(function(val){
                        if (val !== undefined && val["value"]==0){
                            $("#first-visit-button").click();
                        }
                    });
                });
            });

    (function() {
        'use strict';
        //check for support
        if (!('indexedDB' in window)) {
            console.log('This browser doesn\'t support IndexedDB');
        return;
        }
        var dbPromise = idb.open('endless-farming-db', 2,  function(upgradeDb) {
            switch (upgradeDb.oldVersion) {
                case 0:
                    if (!upgradeDb.objectStoreNames.contains('units')) {
                        var unitsOS = upgradeDb.createObjectStore('units', {keyPath: 'name'});
                        unitsOS.createIndex('nsr', 'nsr', {unique: false});
                        unitsOS.createIndex('sr', 'sr', {unique: false});
                    }
                    if (!upgradeDb.objectStoreNames.contains('pets')) {
                        var petsOS = upgradeDb.createObjectStore('pets', {keyPath: 'name'});
                        petsOS.createIndex('fragments', 'fragments', {unique: false});
                    }
                case 1:
                    if(!upgradeDb.objectStoreNames.contains('player')){
                        var playerOS = upgradeDb.createObjectStore('player', {keyPath: 'name', autoIncrement:true});
                        playerOS.createIndex('value', 'value', {unique: false});
                        playerOS.get("KL").then(function(val){
                            if (val == undefined){
                                playerOS.put({"name": "KL", "value": 0});
                            }
                        });
                        playerOS.get("KL").then(function(val){
                            if (val == undefined){
                                playerOS.put({"name": "tickets", "value": 0});
                            }
                        });
                        playerOS.get("KL").then(function(val){
                            if (val == undefined){
                                playerOS.put({"name": "refills", "value": 0});
                            }
                        });
                    }
                    var petsOS = upgradeDb.transaction.objectStore('pets');
                    petsOS.createIndex('priority', 'priority', {unique: false});
            }   
        });
    })();
        }));
    </script>


  </body>
</html>
